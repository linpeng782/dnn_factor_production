# 命令行参数详解 - 新手教程

## 什么是命令行参数？

命令行参数就是在运行程序时，通过命令行传递给程序的信息。

**对比**：

### 旧方式（需要修改代码）
```python
# 每次都要打开文件修改这些值
dataset_end_date = "20251015"  # 要改日期就得改这里
test_limit = 50                # 要改数量就得改这里
```

### 新方式（命令行参数）
```bash
# 不用改代码，直接在命令行指定
python run_batch_factor_processing.py --date 20251015 --limit 50
```

---

## 核心概念：参数组合

**重要**：所有参数都是**可选的**，可以自由组合！

### 参数列表

| 参数 | 作用 | 默认值 | 必需？ |
|------|------|--------|--------|
| `--date` | 指定处理哪天的数据 | 今天 | ❌ |
| `--mode` | 运行模式 | `batch` | ❌ |
| `--stock` | 股票代码（single模式用） | `000001.XSHE` | ❌ |
| `--workers` | 线程数 | `4` | ❌ |
| `--limit` | 限制处理数量 | `None`（全部） | ❌ |

---

## 详细示例讲解

### 示例1：最简单的用法
```bash
python run_batch_factor_processing.py
```

**解释**：
- 没有任何参数
- 使用**今天的日期**
- 处理**所有股票**
- 使用 **4个线程**

**等同于**：
```bash
python run_batch_factor_processing.py --date 今天 --mode batch --workers 4 --limit 全部
```

---

### 示例2：处理指定日期
```bash
python run_batch_factor_processing.py --date 20251015
```

**解释**：
- `--date 20251015`：处理 **2025年10月15日** 的数据
- 其他参数用默认值

**实际效果**：
- 读取数据：`/Users/didi/Data/dnn_model/raw/日线后复权及常用指标csv/`
- 输出到：`/Users/didi/Data/dnn_model/enhanced/enhanced_factors_csv_20251015/`
- 处理所有股票

---

### 示例3：测试模式（10只股票）
```bash
python run_batch_factor_processing.py --limit 10
```

**解释**：
- `--limit 10`：只处理 **前10只股票**
- 用于快速测试，不用等很久

**实际效果**：
- 处理今天的数据
- 只处理前10只股票（不是全部5000多只）
- 大约5-10秒就完成

**为什么要用 `--limit`？**
- ✅ 快速测试代码是否正常
- ✅ 不用等30分钟处理全部股票
- ✅ 节省时间和资源

---

### 示例4：测试单只股票
```bash
python run_batch_factor_processing.py --mode single --stock 000001.XSHE
```

**解释**：
- `--mode single`：切换到**单股测试模式**
- `--stock 000001.XSHE`：指定股票代码（平安银行）

**实际效果**：
- 只处理平安银行这一只股票
- 大约2-3秒完成
- 用于调试某只股票的问题

**其他股票示例**：
```bash
# 测试贵州茅台
python run_batch_factor_processing.py --mode single --stock 600519.XSHG

# 测试招商银行
python run_batch_factor_processing.py --mode single --stock 600036.XSHG
```

---

### 示例5：重试失败的股票
```bash
python run_batch_factor_processing.py --mode retry
```

**解释**：
- `--mode retry`：重试之前失败的股票

**使用场景**：
1. 先运行批量处理：`python run_batch_factor_processing.py`
2. 发现有3只股票失败
3. 运行重试：`python run_batch_factor_processing.py --mode retry`

**实际效果**：
- 读取失败日志：`log/failed_stocks_*.txt`
- 只处理失败的股票
- 不会重复处理成功的股票

---

### 示例6：重试指定日期的失败股票
```bash
python run_batch_factor_processing.py --date 20251015 --mode retry
```

**解释**：
- `--date 20251015`：指定日期
- `--mode retry`：重试模式

**实际效果**：
- 重试 2025年10月15日 失败的股票
- 读取：`log/failed_stocks_20251015.txt`

---

### 示例7：使用更多线程
```bash
python run_batch_factor_processing.py --workers 8
```

**解释**：
- `--workers 8`：使用 **8个线程** 并行处理

**效果对比**：
- 4个线程（默认）：处理5000只股票约30分钟
- 8个线程：处理5000只股票约15分钟

**注意**：
- 线程太多可能导致米筐API限流
- 建议：4-8个线程

---

### 示例8：组合使用
```bash
python run_batch_factor_processing.py --date 20251010 --limit 50 --workers 8
```

**解释**：
- `--date 20251010`：处理10月10日的数据
- `--limit 50`：只处理50只股票
- `--workers 8`：使用8个线程

**实际效果**：
- 处理2025年10月10日的数据
- 只处理前50只股票
- 使用8个线程并行
- 大约10秒完成

---

## 参数的顺序重要吗？

**不重要！** 以下都是一样的：

```bash
# 方式1
python run_batch_factor_processing.py --date 20251015 --limit 10

# 方式2
python run_batch_factor_processing.py --limit 10 --date 20251015

# 方式3
python run_batch_factor_processing.py --limit 10 --workers 8 --date 20251015
```

---

## 常见问题

### Q1: `--limit 10` 是测试哪天的股票？

**答**：取决于 `--date` 参数

```bash
# 测试今天的前10只股票
python run_batch_factor_processing.py --limit 10

# 测试10月15日的前10只股票
python run_batch_factor_processing.py --date 20251015 --limit 10

# 测试10月10日的前10只股票
python run_batch_factor_processing.py --date 20251010 --limit 10
```

### Q2: 如何知道处理了哪些股票？

**答**：查看日志

```bash
# 查看最新日志
tail -100 /Users/didi/Data/dnn_model/logs/factor_*.log

# 或查看输出目录
ls /Users/didi/Data/dnn_model/enhanced/enhanced_factors_csv_20251015/
```

### Q3: 如何查看失败的股票？

**答**：查看失败报告

```bash
# 查看汇总报告
cat /Users/didi/dnn_model/factor_engineering/log/failed_summary_*.txt

# 查看详细日志
cat /Users/didi/dnn_model/factor_engineering/log/failed_stocks_*.txt
```

### Q4: 参数写错了会怎样？

**答**：程序会提示错误

```bash
# 错误示例
python run_batch_factor_processing.py --date 2025-10-15
# 错误：日期格式应该是 20251015，不是 2025-10-15

python run_batch_factor_processing.py --mode test
# 错误：mode 只能是 batch、single 或 retry
```

---

## 实战流程

### 场景1：开发测试
```bash
# 1. 先测试1只股票
python run_batch_factor_processing.py --mode single --stock 000001.XSHE

# 2. 测试10只股票
python run_batch_factor_processing.py --limit 10

# 3. 确认无误后，处理全部
python run_batch_factor_processing.py
```

### 场景2：日常运行
```bash
# 每天定时运行（cron会自动执行）
# 无需手动运行
```

### 场景3：补充历史数据
```bash
# 补充10月10日的数据
python run_batch_factor_processing.py --date 20251010

# 补充10月11日的数据
python run_batch_factor_processing.py --date 20251011

# 补充10月12日的数据
python run_batch_factor_processing.py --date 20251012
```

### 场景4：处理失败重试
```bash
# 1. 运行批量处理
python run_batch_factor_processing.py --date 20251015

# 2. 查看失败报告
cat log/failed_summary_20251015.txt

# 3. 重试失败的股票
python run_batch_factor_processing.py --date 20251015 --mode retry
```

---

## 查看帮助

随时可以查看帮助信息：

```bash
python run_batch_factor_processing.py --help
```

输出：
```
usage: run_batch_factor_processing.py [-h] [--date DATE] 
                                      [--mode {batch,single,retry}]
                                      [--stock STOCK] [--workers WORKERS]
                                      [--limit LIMIT]

每日因子处理

options:
  -h, --help            show this help message and exit
  --date DATE           数据日期(YYYYMMDD)，默认今天
  --mode {batch,single,retry}
                        运行模式: batch=批量处理, single=单股测试, retry=重试失败
  --stock STOCK         单股模式下的股票代码
  --workers WORKERS     线程数
  --limit LIMIT         限制股票数量
```

---

## 总结

### 最常用的3个命令

```bash
# 1. 日常运行（处理今天的所有股票）
python run_batch_factor_processing.py

# 2. 快速测试（只处理10只）
python run_batch_factor_processing.py --limit 10

# 3. 重试失败
python run_batch_factor_processing.py --mode retry
```

### 记住这个规则

**参数 = 选项**

- 不写参数 = 使用默认值
- 写了参数 = 覆盖默认值
- 参数可以自由组合
- 参数顺序不重要

---

现在你已经掌握命令行参数了！🎉
